<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion des Clients</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <nav class="main-menu">
      <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      
      <div class="nav-links">
        <a href="/">Reçu</a>
        <a href="/expenses">Dépense</a>
        <a href="/dashboard">Tableau de bord</a>
      </div>
      
      <div class="profile-menu">
        <div class="profile-trigger" onclick="this.parentElement.classList.toggle('active')">
          <div class="profile-avatar">{{ session.username[0] if session.username else 'U' }}</div>
          <span class="profile-name">{{ session.username }}</span>
        </div>
        <div class="profile-dropdown">
          {% if session.username == 'admin' %}
          <a href="/admin">Gérer les utilisateurs</a>
          <a href="/clients">Gérer les clients</a>
          {% endif %}
          <a href="/account">Mon compte</a>
          <a href="/logout">Déconnexion</a>
        </div>
      </div>
    </nav>
    
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-menu">
      <div class="mobile-menu-header">
        <div class="profile-info">
          <div class="profile-avatar">{{ session.username[0] if session.username else 'U' }}</div>
          <span class="profile-name">{{ session.username }}</span>
        </div>
        <button class="close-menu" onclick="closeMobileMenu()" aria-label="Fermer">&times;</button>
      </div>
      <div class="mobile-menu-links">
        <a href="/">Reçu</a>
        <a href="/expenses">Dépense</a>
        <a href="/dashboard">Tableau de bord</a>
        {% if session.username == 'admin' %}
        <a href="/admin">Gérer les utilisateurs</a>
        <a href="/clients">Gérer les clients</a>
        {% endif %}
        <a href="/account">Mon compte</a>
        <a href="/logout">Déconnexion</a>
      </div>
    </div>
    
    <script>
      function toggleMobileMenu() {
        document.querySelector('.mobile-menu').classList.toggle('active');
        document.querySelector('.mobile-overlay').classList.toggle('active');
        document.body.style.overflow = document.querySelector('.mobile-menu').classList.contains('active') ? 'hidden' : '';
      }
      
      function closeMobileMenu() {
        document.querySelector('.mobile-menu').classList.remove('active');
        document.querySelector('.mobile-overlay').classList.remove('active');
        document.body.style.overflow = '';
      }
    </script>

    <div class="admin-page">
      <div class="admin-header">
        <h1>Gestion des Clients</h1>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="flash-messages">
          {% for category, msg in messages %}
            <li class="{{ category }}">{{ msg }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <div class="admin-section">
        <h2>Ajouter un Client</h2>
        <form method="post" action="{{ url_for('clients_add') }}" class="admin-form" style="display: block;">
          <div class="form-row">
            <div class="form-group">
              <label>Nom du client *</label>
              <input name="name" placeholder="Ex: Cabinet Dr. Dupont" required>
            </div>
            <div class="form-group">
              <label>Type</label>
              <input name="type" placeholder="Ex: Dentaire">
            </div>
          </div>
          <div class="form-group">
            <label>Adresse</label>
            <input name="address" placeholder="Ex: 123 Rue de la Santé, 75000 Paris">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date de début *</label>
              <input name="start_date" type="date" required>
            </div>
            <div class="form-group">
              <label>Statut</label>
              <select name="status">
                <option value="active">Actif</option>
                <option value="pending">En attente</option>
                <option value="stopped">Arrêté</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Frais d'installation (XOF)</label>
              <input name="installation_fee" type="number" step="1" placeholder="0">
            </div>
            <div class="form-group">
              <label>Paiement mensuel (XOF)</label>
              <input name="monthly_payment" type="number" step="1" placeholder="0">
            </div>
          </div>
          <button type="submit" class="btn-small">Ajouter le client</button>
        </form>
      </div>

      <div class="admin-section">
        <h2>Tous les Clients</h2>
        <div class="admin-table-wrapper">
          <table class="admin-table clients-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Adresse</th>
                <th>Début</th>
                <th>Mensuel</th>
                <th>Statut</th>
                <th style="width: 180px; text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody>
            {% for client in clients %}
              <tr>
                <td><strong>{{ client.name }}</strong></td>
                <td>{{ client.type or '-' }}</td>
                <td>{{ client.address or '-' }}</td>
                <td>{{ client.start_date.strftime('%Y-%m-%d') if client.start_date else '-' }}</td>
                <td>{{ "{:,.0f}".format(client.monthly_payment) }} XOF</td>
                <td>
                  <span class="status-badge status-{{ client.status }}">
                    {% if client.status == 'active' %}Actif
                    {% elif client.status == 'pending' %}En attente
                    {% elif client.status == 'stopped' %}Arrêté
                    {% else %}{{ client.status }}{% endif %}
                  </span>
                </td>
                <td style="text-align: center;">
                  <button class="btn-small" onclick="editClient({{ client.id }})">Modifier</button>
                  <form method="post" action="{{ url_for('clients_delete', client_id=client.id) }}" style="display:inline" onsubmit="return confirmClientDelete('{{ client.name }}')">
                    <button class="btn-danger-small" type="submit">Supprimer</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="user-count">Total des clients: {{ clients|length }}</p>
      </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="delete-modal-overlay" id="editClientModal">
      <div class="delete-modal" style="max-width: 600px;">
        <h3>Modifier le Client</h3>
        <form id="editClientForm" method="post" class="admin-form" style="display: block;">
          <div class="form-row">
            <div class="form-group">
              <label>Nom du client *</label>
              <input name="name" id="edit_name" required>
            </div>
            <div class="form-group">
              <label>Type</label>
              <input name="type" id="edit_type">
            </div>
          </div>
          <div class="form-group">
            <label>Adresse</label>
            <input name="address" id="edit_address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date de début *</label>
              <input name="start_date" id="edit_start_date" type="date" required>
            </div>
            <div class="form-group">
              <label>Date de fin</label>
              <input name="end_date" id="edit_end_date" type="date">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Frais d'installation (XOF)</label>
              <input name="installation_fee" id="edit_installation_fee" type="number" step="1">
            </div>
            <div class="form-group">
              <label>Paiement mensuel (XOF)</label>
              <input name="monthly_payment" id="edit_monthly_payment" type="number" step="1">
            </div>
          </div>
          <div class="form-group">
            <label>Statut</label>
            <select name="status" id="edit_status">
              <option value="active">Actif</option>
              <option value="pending">En attente</option>
              <option value="stopped">Arrêté</option>
            </select>
          </div>
          <div class="delete-modal-actions">
            <button type="button" class="delete-modal-cancel" onclick="closeEditClientModal()">Annuler</button>
            <button type="submit" class="btn-small">Sauvegarder</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Auto-hide flash messages after 5 seconds
      setTimeout(function() {
        const flashMessages = document.querySelector('.flash-messages');
        if (flashMessages) {
          flashMessages.style.transition = 'opacity 0.5s ease-out';
          flashMessages.style.opacity = '0';
          setTimeout(function() {
            flashMessages.style.display = 'none';
          }, 500);
        }
      }, 5000);

      // Client management functions
      function editClient(clientId) {
        fetch('/api/clients/' + clientId)
          .then(response => response.json())
          .then(client => {
            document.getElementById('edit_name').value = client.name || '';
            document.getElementById('edit_type').value = client.type || '';
            document.getElementById('edit_address').value = client.address || '';
            document.getElementById('edit_installation_fee').value = client.installation_fee || '';
            document.getElementById('edit_monthly_payment').value = client.monthly_payment || '';
            document.getElementById('edit_status').value = client.status || 'active';
            
            document.getElementById('editClientForm').action = '/clients/edit/' + clientId;
            document.getElementById('editClientModal').classList.add('active');
          })
          .catch(err => {
            alert('Erreur lors du chargement des données du client');
          });
      }

      function closeEditClientModal() {
        document.getElementById('editClientModal').classList.remove('active');
      }

      function confirmClientDelete(clientName) {
        return confirm('Voulez-vous vraiment supprimer le client "' + clientName + '" ?');
      }

      // Close edit modal on overlay click
      document.getElementById('editClientModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeEditClientModal();
        }
      });

      // Close edit modal on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('editClientModal').classList.contains('active')) {
          closeEditClientModal();
        }
      });
    </script>
  </body>
</html>
